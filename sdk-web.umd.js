(function(l,y){typeof exports=="object"&&typeof module<"u"?y(exports):typeof define=="function"&&define.amd?define(["exports"],y):(l=typeof globalThis<"u"?globalThis:l||self,y(l.SdkWeb=l.SdkWeb||{}))})(this,function(l){"use strict";var le=Object.defineProperty;var ge=(l,y,E)=>y in l?le(l,y,{enumerable:!0,configurable:!0,writable:!0,value:E}):l[y]=E;var K=(l,y,E)=>(ge(l,typeof y!="symbol"?y+"":y,E),E);const y={alpha:{basedDomain:"https://miniapp-web.vissoft.vn"},production:{basedDomain:"https://api23.vtmoney.vn"},uat:{basedDomain:"https://api24cdn.vtmoney.vn/uatmm"},staging:{basedDomain:"http://125.235.38.229:8080"}},E={initKeyChainUrl:"/webappv2/miniapp-be/public/api/v1/dh/initiate",exchangeKeySecretUrl:"/webappv2/miniapp-be/public/api/v1/dh/exchange"},N="/webappv2/miniapp-be/public/api/v1/msisdn/white-list",B="/webappv2/miniapp-be/public/api/v1/grant-partner/partner-link",U="MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgG7/RewAH18PBkJyz85hh1KD1AWPKcJTZ/xGW/ffx7l+hRANCAAQfx1YBNGBlMvf//5h6Yjuhu7/VrmZ5LvS4fe9NPwKxptml3OwOxUtzH/m6ICS3yE/iZoKMyG+mKWNr/u7wTMRt",_={productMode:y,encryptExchangeEndPoint:E,getEnvUrl:N,getPartnerLinkUrl:B,secretDigitalSignature:U};class k{constructor(){this.store={}}getItem(e){return this.store[e]||null}setItem(e,t){this.store[e]=t.toString()}removeItem(e){delete this.store[e]}clear(){this.store={}}logLocalStorage(){return this.store}}const g=new k,D=class D{static generateIMEI(){let e="";for(let o=0;o<14;o++)e+=Math.floor(Math.random()*10).toString();let t=0;for(let o=0;o<14;o++){let s=parseInt(e[o]);o%2===0&&(s*=2,s>9&&(s-=9)),t+=s}const n=(10-t%10)%10;return e+=n.toString(),e}static getEnv(){let e=g.getItem("MINIAPP_SDK_sdk_productMode");return e=e!==""?e:"staging",{productMode:y[e],encryptExchangeEndPoint:E,secretDigitalSignature:U,getPartnerLinkUrl:B,getEnvUrl:N}}static getUserInformation(){try{const e=g.getItem("MINIAPP_SDK_user_information"),t=e?JSON.parse(e):"";if(t!=="")return t==null?void 0:t.auth}catch{return""}}static async checkKeyExist(e,t){const n=g.getItem("MINIAPP_SDK_serverKey_"+e),o=g.getItem("MINIAPP_SDK_userClientKey_"+e);return g.getItem("MINIAPP_SDK_imei_component")===t&&n!==""&&(n==null?void 0:n.shareKey)!==""&&o!==""&&(o==null?void 0:o.privateKey)!==""&&(o==null?void 0:o.publicKey)!==""}static sanitizeUrl(e){return/^[a-zA-Z-_]+:/.test(e)||(e="http://"+e),e.toLowerCase()}static extractOrigin(e){const t=/^[A-Za-z][A-Za-z0-9+\-.]+:(\/\/)?[^/]*/.exec(e);return t===null?"":t[0]}static formatPhoneNumber(e){let t=e.slice(0,1),n=e.slice(1,e.length);return t==="0"?"84"+n:e}static generateResponseId(){return"APP_"+Date.now()}static uuidNextVal(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)}).toUpperCase()}static convertStringToJson(e){try{return JSON.parse(e)}catch{return e}}static convertJsonToString(e){try{return JSON.stringify(e)}catch{return e}}static convertDataToSign(e){try{const t=JSON.stringify(e);return btoa(t)}catch{return e}}static paginate(e,t,n){return e.slice((n-1)*t,n*t)}static filterString(e,t,n){const o=this.convertViToEn(t),s=this.convertViToEn(n),i=this.convertViToEn(e).split(" ");let a=!0;return o.length<=0?!1:(i.length>0&&i.forEach(c=>{if(!(o.indexOf(c)!==-1||s.indexOf(c)!==-1)){a=!1;return}}),a)}static convertViToEn(e,t=!1){return e=e.toLowerCase(),e=e.replace(/√†|√°|·∫°|·∫£|√£|√¢|·∫ß|·∫•|·∫≠|·∫©|·∫´|ƒÉ|·∫±|·∫Ø|·∫∑|·∫≥|·∫µ/g,"a"),e=e.replace(/√®|√©|·∫π|·∫ª|·∫Ω|√™|·ªÅ|·∫ø|·ªá|·ªÉ|·ªÖ/g,"e"),e=e.replace(/√¨|√≠|·ªã|·ªâ|ƒ©/g,"i"),e=e.replace(/√≤|√≥|·ªç|·ªè|√µ|√¥|·ªì|·ªë|·ªô|·ªï|·ªó|∆°|·ªù|·ªõ|·ª£|·ªü|·ª°/g,"o"),e=e.replace(/√π|√∫|·ª•|·ªß|≈©|∆∞|·ª´|·ª©|·ª±|·ª≠|·ªØ/g,"u"),e=e.replace(/·ª≥|√Ω|·ªµ|·ª∑|·ªπ/g,"y"),e=e.replace(/ƒë/g,"d"),e=e.replace(/\u0300|\u0301|\u0303|\u0309|\u0323/g,""),e=e.replace(/\u02C6|\u0306|\u031B/g,""),e=e.replace(/  +/g," "),e=e.replace(/[^a-zA-Z0-9 ]/g,""),t?e.toUpperCase():e}static filterMsisdnByEnv(e,t,n){let o="production";return n.length>0&&n.filter(i=>e===i).length>0?(o="staging",o):(t.length>0&&t.filter(i=>e===i).length&&(o="uat"),o)}static getDeviceInfo(){var o,s,i,a,c;const e=navigator.userAgent||navigator.vendor||window.opera;let t="Unknown",n="Unknown";return/windows nt 10.0/i.test(e)?(t="Windows",n="10"):/windows nt 11.0/i.test(e)?(t="Windows",n="11"):/macintosh|mac os x/i.test(e)?(t="macOS",n=((s=(o=e.match(/Mac OS X (\d+[_\d]*)/))==null?void 0:o[1])==null?void 0:s.replace(/_/g,"."))||"Unknown"):/android/i.test(e)?(t="Android",n=((i=e.match(/Android\s([0-9.]*)/))==null?void 0:i[1])||"Unknown"):/iphone|ipad/i.test(e)?(t="iOS",n=((c=(a=e.match(/OS (\d+[_\d]+)/))==null?void 0:a[1])==null?void 0:c.replace(/_/g,"."))||"Unknown"):/linux/i.test(e)&&(t="Linux",n="Unknown"),{os:t,osVersion:n}}static async generateClientId(){console.log("üîç [DEBUG] generateClientId called");try{let e=await D.getClientIdFromIndexedDB();if(console.log("üîç [DEBUG] Retrieved clientId"),e)console.log("üîç [DEBUG] Using existing clientId");else{console.log("üîç [DEBUG] No existing clientId found, creating new one...");const t=Date.now(),n=Math.floor(Math.random()*1e4);e=`DEVICE_${t}_${n}`,console.log("üîç [DEBUG] Generated new clientId"),await D.saveClientIdToIndexedDB(e),console.log("üîç [DEBUG] Saved clientId successfully")}return e}catch(e){return console.warn("‚ö†Ô∏è [DEBUG] Storage error, using fallback:",e),D.generateClientIdFallback()}}static async saveClientIdToIndexedDB(e){return console.log("üîç [DEBUG] saveClientIdToIndexedDB called"),new Promise((t,n)=>{if(!window.indexedDB){console.warn("‚ö†Ô∏è [DEBUG] Storage not supported"),n(new Error("Storage not supported"));return}const o=indexedDB.open("SDKStorage",1);o.onerror=()=>{console.warn("‚ö†Ô∏è [DEBUG] Storage open error:",o.error),n(o.error)},o.onsuccess=()=>{try{const c=o.result.transaction(["clientData"],"readwrite").objectStore("clientData").put({key:"device_client_id",value:e});c.onsuccess=()=>{console.log("‚úÖ [DEBUG] Successfully saved clientId"),t()},c.onerror=()=>{console.warn("‚ö†Ô∏è [DEBUG] Storage save error:",c.error),n(c.error)}}catch(s){console.warn("‚ö†Ô∏è [DEBUG] Storage transaction error:",s),n(s)}},o.onupgradeneeded=s=>{try{const i=s.target.result;i.objectStoreNames.contains("clientData")||(i.createObjectStore("clientData",{keyPath:"key"}),console.log("üîç [DEBUG] Created storage objectStore"))}catch(i){console.warn("‚ö†Ô∏è [DEBUG] Storage upgrade error:",i),n(i)}},setTimeout(()=>{console.warn("‚ö†Ô∏è [DEBUG] Storage timeout"),n(new Error("Storage timeout"))},5e3)})}static async getClientIdFromIndexedDB(){return console.log("üîç [DEBUG] get exists clientId called"),new Promise((e,t)=>{if(!window.indexedDB){console.warn("‚ö†Ô∏è [DEBUG] Storage not supported, returning null"),e(null);return}const n=indexedDB.open("SDKStorage",1);n.onerror=()=>{console.warn("‚ö†Ô∏è [DEBUG] Storage open error:",n.error),e(null)},n.onsuccess=()=>{try{const a=n.result.transaction(["clientData"],"readonly").objectStore("clientData").get("device_client_id");a.onsuccess=()=>{const c=a.result?a.result.value:null;console.log("üîç [DEBUG] Retrieved clientId"),e(c)},a.onerror=()=>{console.warn("‚ö†Ô∏è [DEBUG] Storage get error:",a.error),e(null)}}catch(o){console.warn("‚ö†Ô∏è [DEBUG] Storage transaction error:",o),e(null)}},n.onupgradeneeded=o=>{try{const s=o.target.result;s.objectStoreNames.contains("clientData")||(s.createObjectStore("clientData",{keyPath:"key"}),console.log("üîç [DEBUG] Created storage objectStore"))}catch(s){console.warn("‚ö†Ô∏è [DEBUG] Storage upgrade error:",s),e(null)}},setTimeout(()=>{console.warn("‚ö†Ô∏è [DEBUG] Storage timeout, returning null"),e(null)},3e3)})}static generateClientIdFallback(e=null){console.log("üîç [DEBUG] generateClientIdFallback called");let t=g.getItem("device_client_id");if(console.log("üîç [DEBUG] Retrieved clientId from fallback"),t)console.log("üîç [DEBUG] Using existing clientId from fallback");else{console.log("üîç [DEBUG] No existing clientId found, creating new one...");const n=Date.now(),o=Math.floor(Math.random()*1e4);t=`DEVICE_${n}_${o}`,console.log("üîç [DEBUG] Generated new clientId in fallback"),g.setItem("device_client_id",t),console.log("üîç [DEBUG] Saved clientId successfully")}return t}static checkIndexedDBSupport(){if(!window.indexedDB)return!1;const e=navigator.userAgent.toLowerCase();return/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(e)&&(/safari/.test(e)&&/iphone|ipad|ipod/.test(e)||/chrome/.test(e)&&/android/.test(e)),!0}};K(D,"defaultResponseToWebview",{sender:"MINIAPP_SDK",response_id:"",request_id:"",event:"",data:"",token:""}),K(D,"defaultResponseToWebview",{sender:"MINIAPP_SDK",response_id:"",request_id:"",event:"",data:"",token:""});let u=D;const C="http://125.235.38.229:8080/webappv2/miniapp-be/public/api/v1",V=async r=>{try{const e=await fetch(`${C}/auth/login`,{method:"POST",headers:{Connection:"keep-alive","Partner-Link":"SFVFU19IVUVTX0hPTUU=","Accept-Language":"vi","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) SFive/80.0 Chrome/80.0.3987.123 Safari/537.36","Order-Id":"202408130946","Content-Type":"application/json",Accept:"application/json, text/plain, */*","Device-Id":"water-deviceId",imei:r.imei,Os:r.os,Origin:"http://125.235.38.229:8080",Referer:"http://125.235.38.229:8080/webappv2/miniapp-fe/?partner_link=SFVFU19IVUVTX0hPTUU%3D&mock=true"},body:JSON.stringify(r)});if(!e.ok){const t=await e.json();throw new Error(t.error||"Login failed")}return await e.json()}catch(e){throw e}},O=async r=>{try{const e=await fetch(`${C}/auth/login/verify-otp`,{method:"POST",headers:{Connection:"keep-alive","Partner-Link":"SFVFU19IVUVTX0hPTUU=","Accept-Language":"vi","User-Agent":"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) SFive/80.0 Chrome/80.0.3987.123 Safari/537.36","Order-Id":"202408130946","Content-Type":"application/json",Accept:"application/json, text/plain, */*","Device-Id":"water-deviceId",imei:"33abdab5-83hg-1122-a88a-b98c56b123th",Os:"android",Origin:"http://125.235.38.229:8080",Referer:"http://125.235.38.229:8080/webappv2/miniapp-fe/?partner_link=SFVFU19IVUVTX0hPTUU%3D&mock=true"},body:JSON.stringify(r)});if(!e.ok){const t=await e.json();throw new Error(t.error||"OTP verification failed")}return await e.json()}catch(e){throw e}};async function L(r,e){try{const t=BigInt("0x"+r),n=BigInt("0x"+e),o=crypto.getRandomValues(new Uint8Array(256)),s=BigInt("0x"+Array.from(o).map(d=>d.toString(16).padStart(2,"0")).join(""))%(t-1n),i=P(n,s,t),a=v(i),c=v(s);return{privateKeyHex:s.toString(16),publicKeyHex:i.toString(16),clientPrivateKeyBase64:w(c),clientPublicKeyBase64:w(a),privateKeyBigInt:s,publicKeyBigInt:i}}catch(t){throw console.error("L·ªói khi t·∫°o c·∫∑p kh√≥a DH:",t),t}}function w(r){try{const e=new Uint8Array(r);let t="";for(let n=0;n<e.byteLength;n++)t+=String.fromCharCode(e[n]);return window.btoa(t)}catch(e){throw console.error("Error converting ArrayBuffer to base64:",e),new Error("Error converting to base64")}}async function R(r,e,t){const n=BigInt("0x"+t),o=Uint8Array.from(atob(r),h=>h.charCodeAt(0)),s=BigInt("0x"+Array.from(o).map(h=>h.toString(16).padStart(2,"0")).join("")),i=Uint8Array.from(atob(e),h=>h.charCodeAt(0)),a=BigInt("0x"+Array.from(i).map(h=>h.toString(16).padStart(2,"0")).join("")),c=P(s,a,n);return w(v(c))}function P(r,e,t){if(t===1n)return 0n;let n=1n;for(r=r%t;e>0n;)e%2n===1n&&(n=n*r%t),r=r*r%t,e=e/2n;return n}function v(r){const e=r.toString(16).padStart(2,"0"),t=new Uint8Array(e.length/2);for(let n=0;n<e.length;n+=2)t[n/2]=parseInt(e.substr(n,2),16);return t}async function W(r,e){try{if(!r||!e)throw new Error("Invalid input: plain data or key is missing");const n=new TextEncoder().encode(r),o=Uint8Array.from(atob(e),M=>M.charCodeAt(0)),s=12,i=16,a=await crypto.subtle.digest("SHA-256",o),c=await crypto.subtle.importKey("raw",a,{name:"AES-GCM"},!1,["encrypt"]),d=crypto.getRandomValues(new Uint8Array(s)),h=await crypto.subtle.encrypt({name:"AES-GCM",iv:d,tagLength:128},c,n),m=new Uint8Array(d.length+h.byteLength);return m.set(d,0),m.set(new Uint8Array(h),d.length),btoa(String.fromCharCode(...m))}catch(t){throw console.error("Encryption failed with error:",t),t}}async function H(r,e){try{if(!(r!=null&&r.encrypted)||!e)throw new Error("D·ªØ li·ªáu m√£ h√≥a ho·∫∑c kh√≥a b·ªã thi·∫øu");const t=12,n=16,o=Uint8Array.from(atob(r.encrypted),S=>S.charCodeAt(0)),s=Uint8Array.from(atob(e),S=>S.charCodeAt(0)),i=await crypto.subtle.digest("SHA-256",s),a=await crypto.subtle.importKey("raw",i,{name:"AES-GCM"},!1,["decrypt"]),c=o.slice(0,t),d=o.slice(t),h=await crypto.subtle.decrypt({name:"AES-GCM",iv:c},a,d);return new TextDecoder().decode(h)}catch(t){throw console.error("Gi·∫£i m√£ th·∫•t b·∫°i:",t),t instanceof DOMException&&console.error("L·ªói thao t√°c crypto:",t.name),t}}class q{constructor(){this.keyStorage=new Map}async genDhKeyFromServer(e,t){var o,s;if(e===""||e===void 0)return"";let n="";try{const{clientPrivateKey:i,clientPublicKey:a,clientPrivateKeyBase64:c,clientPublicKeyBase64:d,privateKeyBigInt:h,publicKeyBigInt:m}=await L(e.p,e.g);n="GEN_KEY_CLIENT";let S=await J(d,t);if(S!==""&&((o=S==null?void 0:S.status)==null?void 0:o.code)==="00"){g.setItem("MINIAPP_SDK_userClientKey_"+(t==null?void 0:t.username),JSON.stringify({privateKey:i,publicKey:a,privateKeyBase64:c,publicKeyBase64:d})),n="EXCHANGE_PUB_KEY";let M=await R(e.publicKey,c,e.p),T=e;T.shareKey=M,g.setItem("MINIAPP_SDK_serverKey_"+(t==null?void 0:t.username),JSON.stringify(T)),n="SAVE_SHARE_KEY"}else return(s=S==null?void 0:S.status)==null?void 0:s.code;return n}catch(i){return console.error("L·ªói trong genDhKeyFromServer:",i),""}}async encryptData(e){const t=u.convertJsonToString(e),n=u.getUserInformation(),o=JSON.parse(g.getItem("MINIAPP_SDK_serverKey_"+(n==null?void 0:n.username)));return o!==""&&(o==null?void 0:o.shareKey)!==""?W(t,o==null?void 0:o.shareKey).then(async s=>{if(s!==""){const i=await $(s);return{data:{encrypted:s,signature:i},token:n==null?void 0:n.accessToken,eventStatus:{errorCode:"SDK000",errorMessageVN:"Th√†nh c√¥ng",errorMessageEN:"Success"}}}return""}):""}async decryptData(e){const t=u.getUserInformation(),n=JSON.parse(g.getItem("MINIAPP_SDK_serverKey_"+(t==null?void 0:t.username)));let o={},s={errorCode:"SDK000",errorMessageVN:"Th√†nh c√¥ng",errorMessageEN:"Success"};return n!==""&&(n==null?void 0:n.shareKey)!==""?await H(e,n==null?void 0:n.shareKey).then(i=>{if(i===""||i.toLowerCase().indexOf("error:1e000065")>=0)return o.data="",o.eventStatus={errorCode:"SDK340",errorMessageVN:"L·ªói gi·∫£i m√£ do v·∫•n ƒë·ªÅ h·ªá th·ªëng",errorMessageEN:"System-related decryption error"},i;let a=u.convertStringToJson(i);return o.data=a,o.eventStatus=s,i}).catch(()=>{o.data="",o.eventStatus={errorCode:"SDK340",errorMessageVN:"L·ªói gi·∫£i m√£ do v·∫•n ƒë·ªÅ h·ªá th·ªëng",errorMessageEN:"System-related decryption error"}}):(o.data="",o.eventStatus={errorCode:"SDK301",errorMessageVN:"L·ªói kh√¥ng t√¨m th·∫•y kh√≥a gi·∫£i m√£",errorMessageEN:"Decryption key not found error"}),o.token=t==null?void 0:t.accessToken,o}async callApiExchangeKey(e,t){if(!t)return"";try{const n=u.getEnv(),o=await fetch(`${n.productMode.basedDomain}${n.encryptExchangeEndPoint.exchangeKeySecretUrl}`,{method:"POST",headers:{accept:"application/json","Access-Control-Allow-Origin":"*",Authorization:`Bearer ${t==null?void 0:t.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify({publicKey:e})});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);return await o.json()}catch(n){return console.error("L·ªói trong callApiExchangeKey:",n),""}}async encryptWithKey(e,t){const o=new TextEncoder().encode(e),s=await window.crypto.subtle.importKey("raw",new TextEncoder().encode(t),{name:"AES-GCM"},!1,["encrypt"]),i=window.crypto.getRandomValues(new Uint8Array(12)),a=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:i},s,o),c=new Uint8Array(a),d=new Uint8Array(i.length+c.length);return d.set(i),d.set(c,i.length),btoa(String.fromCharCode(...d))}async decryptWithKey(e,t){try{const n=new Uint8Array(atob(e).split("").map(c=>c.charCodeAt(0))),o=n.slice(0,12),s=n.slice(12),i=await window.crypto.subtle.importKey("raw",new TextEncoder().encode(t),{name:"AES-GCM"},!1,["decrypt"]),a=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:o},i,s);return new TextDecoder().decode(a)}catch(n){return console.error("L·ªói trong decryptWithKey:",n),""}}async generateSign(e){try{const t=await this.getKeyConfig();if(!t)return"";const n=Uint8Array.from(atob(t),c=>c.charCodeAt(0)).buffer,o=await crypto.subtle.importKey("pkcs8",n,{name:"ECDSA",namedCurve:"P-256"},!1,["sign"]),s=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},o,new TextEncoder().encode(e)),i=Z(new Uint8Array(s));return btoa(String.fromCharCode(...i))}catch(t){return console.error("L·ªói signature",t),""}}async saveClientKeys(e,t){this.keyStorage.set(`client_${e}`,t)}async getClientKeys(e){return this.keyStorage.get(`client_${e}`)}async saveServerKeys(e,t){this.keyStorage.set(`server_${e}`,t)}async getServerKeys(e){return this.keyStorage.get(`server_${e}`)}async getKeyConfig(){return this.keyStorage.get("key_config")||_.secretDigitalSignature}async getUserInformation(){return this.keyStorage.get("user_info")||null}async getEnv(){return _}async getEnvWhitelist(){try{const e=await this.getEnv(),t=await fetch(`${e.productMode.basedDomain}${e.getEnvUrl}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const n=await t.json();return(n==null?void 0:n.data)||""}catch(e){return console.error("L·ªói khi l·∫•y danh s√°ch whitelist:",e),""}}async initSDK(e="staging"|"production"|"uat"|"alpha"){if(!e)throw new Error("Environment parameter is required");g.setItem("MINIAPP_SDK_sdk_productMode",e)}}const f=new q,F=()=>f.getEnv(),j=()=>f.getEnvWhitelist(),J=(r,e)=>f.callApiExchangeKey(r,e),$=r=>f.generateSign(r),Y=r=>f.initSDK(r),Z=r=>{const e=r.slice(0,32),t=r.slice(32),n=x(e),o=x(t),s=n.length+o.length;return Uint8Array.from([48,s,...n,...o])},z=r=>{let e=0;for(;e<r.length-1&&r[e]===0;)e++;return r.slice(e)},x=r=>(r=z(r),r[0]&128&&(r=Uint8Array.from([0,...r])),Uint8Array.from([2,r.length,...r])),X=async r=>{var n,o,s,i;const e=await u.checkKeyExist((o=(n=r==null?void 0:r.data)==null?void 0:n.auth)==null?void 0:o.username,(i=(s=r==null?void 0:r.data)==null?void 0:s.auth)==null?void 0:i.imei);let t=await Q(r);if(e)return t;{const a=await G();console.log("genKeyProgress",a);let c={errorCode:"SDK000",errorMessageVN:"Th√†nh c√¥ng",errorMessageEN:"Success"};return a===""||a==="MNA0012"?c={errorCode:"MNA0012",errorMessageVN:"C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh t·∫°o DH key.",errorMessageEN:"DH key error"}:a==="MNA0010"?c={errorCode:"MNA0010",errorMessageVN:"Diffie-Hellman kh√¥ng t·ªìn t·∫°i.",errorMessageEN:"DH key not exist"}:a==="MNA0011"&&(c={errorCode:"MNA0011",errorMessageVN:"Diffie-Hellman h·∫øt h·∫°n, c·∫ßn kh·ªüi t·∫°o l·∫°i.",errorMessageEN:"DH key need to be refreshed"}),t.eventStatus=c,t}};async function Q(r){console.log("üîç [DEBUG] executeLoginSuccess called");const e={sender:"MINIAPP_SDK",response_id:"",request_id:"",event:"",data:"",token:""};e.request_id=r==null?void 0:r.request_id,console.log("üîç [DEBUG] Extracted msisdn"),console.log("üîç [DEBUG] Calling Utils.generateClientId"),e.response_id=u.generateClientId(),console.log("üîç [DEBUG] Generated response_id"),e.event=r==null?void 0:r.event,e.sender="MINIAPP_SDK";let t={errorCode:"SDK000",errorMessageVN:"Th√†nh c√¥ng",errorMessageEN:"Success"};try{return g.setItem("MINIAPP_SDK_user_information",JSON.stringify(r==null?void 0:r.data)),e.data=r==null?void 0:r.data,e.eventStatus=t,console.log("üîç [DEBUG] executeLoginSuccess completed successfully"),e}catch(n){return console.error("‚ùå [DEBUG] executeLoginSuccess error:",n),t.errorCode="SDK010",t.errorMessageVN="L·ªói chung trong qu√° tr√¨nh ƒëƒÉng nh·∫≠p",t.errorMessageEN="General login error",e.eventStatus=t,e}}async function G(){const r=u.getUserInformation(),e=u.getEnv();if(console.log("üîç [DEBUG] userInfo:",r),console.log("üîç [DEBUG] env:",e),r!==""){const t=e.productMode.basedDomain+e.encryptExchangeEndPoint.initKeyChainUrl,n={Authorization:"Bearer "+(r==null?void 0:r.accessToken)};try{const o=await fetch(t,{method:"GET",headers:n});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const s=await o.json();if(console.log("üîç [DEBUG] genKeyCrypt response received"),s!==""){const i=await f.genDhKeyFromServer(s==null?void 0:s.data,r);return console.log("üîç [DEBUG] responseGenKeyDH completed"),i}return""}catch(o){return console.log(o),""}}return""}async function ee(r){console.log("üîç [DEBUG] clearSessionEvent called");const e=u.defaultResponseToWebview;e.request_id=(r==null?void 0:r.request_id)||"",e.response_id=u.uuidNextVal(),e.event=(r==null?void 0:r.event)||"CLEAR_SESSION",e.sender="MINIAPP_SDK";let t={errorCode:"SDK000",errorMessageVN:"Th√†nh c√¥ng",errorMessageEN:"Success"};return e.eventStatus=t,g.removeItem("MINIAPP_SDK_user_information"),e}async function te(r){console.log("üîç [DEBUG] exchangeKey called with data:",r);let e={sender:"MINIAPP_SDK",response_id:u.uuidNextVal(),request_id:r==null?void 0:r.request_id,event:"EXCHANGE_KEY",data:"",eventStatus:{errorCode:"SDK000",errorMessageVN:"Th√†nh c√¥ng",errorMessageEN:"Success"}};try{const t=await G();console.log("üîç [DEBUG] genKeyProgress:",t);let n={errorCode:"SDK000",errorMessageVN:"Th√†nh c√¥ng",errorMessageEN:"Success"};return t===""||t==="MNA0012"?(n={errorCode:"MNA0012",errorMessageVN:"C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh t·∫°o DH key.",errorMessageEN:"DH key error"},console.error("‚ùå [DEBUG] DH key error:",n)):t==="MNA0010"?(n={errorCode:"MNA0010",errorMessageVN:"Diffie-Hellman kh√¥ng t·ªìn t·∫°i.",errorMessageEN:"DH key not exist"},console.error("‚ùå [DEBUG] DH key not exist:",n)):t==="MNA0011"?(n={errorCode:"MNA0011",errorMessageVN:"Diffie-Hellman h·∫øt h·∫°n, c·∫ßn kh·ªüi t·∫°o l·∫°i.",errorMessageEN:"DH key need to be refreshed"},console.error("‚ùå [DEBUG] DH key need to be refreshed:",n)):console.log("‚úÖ [DEBUG] DH key exchange successful"),e.eventStatus=n,e.eventStatus.errorCode!=="SDK000"&&(console.warn("‚ö†Ô∏è [DEBUG] Clearing localStorage due to error:",e.eventStatus),g.clear()),console.log("üîç [DEBUG] exchangeKey response:",e),e}catch(t){return console.error("‚ùå [DEBUG] exchangeKey exception:",t),e.eventStatus={errorCode:"SDK999",errorMessageVN:"L·ªói kh√¥ng x√°c ƒë·ªãnh trong exchangeKey",errorMessageEN:"Unknown error in exchangeKey"},e}}const re={LOGIN:async r=>{const e=await V(r),t={otp:"1111",requestId:(e==null?void 0:e.data.requestId)||"01HZM4PZV4G40XPY5CCKHZAFMW"};return e.status.code==="MNA0302"?e:await O(t)},LOGIN_SUCCESS:async r=>await X(r),ENCRYPT_DATA:async r=>{try{console.log("üîç [DEBUG] ENCRYPT_DATA"),console.log("üîç [DEBUG] payload",r);const{data:e}=r;if(!e)throw new Error("Data is required for encryption");return await f.encryptData(e)}catch(e){return console.error("Encryption error:",e),{data:{encrypted:"ERROR_ENCRYPT_DATA"},eventStatus:{errorCode:"SDK000",errorMessageVN:"Th√†nh c√¥ng",errorMessageEN:"Success"}}}},DECRYPT_DATA:async r=>{try{const{data:e}=r;return await f.decryptData(e)}catch(e){return console.error("Encryption error:",e),{data:{encrypted:"ERROR_DECRYPT_DATA"},eventStatus:{errorCode:"SDK000",errorMessageVN:"Th√†nh c√¥ng",errorMessageEN:"Success"}}}},LOG_STORAGE:async()=>g.logLocalStorage(),EXCHANGE_KEY:async r=>await te(r),CLEAR_SESSION:async r=>await ee(r),EXIT:async r=>closeMiniApp()};async function ne(r,e={}){const t=re[r];if(!t)throw new Error(`Unknown action: ${r}`);return await t(e)}const oe="iframe-miniapp",I={MINIAPP_WEBVIEW:"MINIAPP_WEBVIEW",RESPONSE_SDK_WEB:"RESPONSE_SDK_WEB",MINIAPP_SDK:"MINIAPP_SDK",MINIAPP_BRIDGE:"MINIAPP_BRIDGE"};function A(r){const e=document.getElementById(oe);if(!(e!=null&&e.contentWindow)){console.error("‚ùå Cannot sendMessage ‚Äì iframe not ready");return}e.contentWindow.postMessage(JSON.stringify(r),"*")}function se(r,e){}window.addEventListener("message",r=>{try{console.log("üîç [DEBUG] Received message from MINIAPP_WEBVIEW"),console.log("üîç [DEBUG] event",r);const e=JSON.parse(r.data);e.event&&e.sender===I.MINIAPP_WEBVIEW&&(console.log("üîç [DEBUG] Received message from MINIAPP_WEBVIEW"),ce(e.event,e))}catch(e){console.error("‚ùå Error processing message:",e)}});let p=null;async function ie(r){console.log("üîç [DEBUG] openMiniApp called with options:",r);const{environment:e,url:t,containerId:n="miniapp-container",initData:o}=r;g.setItem("MINIAPP_SDK_sdk_productMode",e);const s=document.getElementById(n);if(!s)return console.log("‚ùå Container not found:",n),{data:null,eventStatus:{errorCode:"SDK001",errorMessageVN:"Container kh√¥ng t√¨m th·∫•y",errorMessageEN:"Container not found"}};try{let i=null;if(o)console.log("üîç [DEBUG] Processing init data from input"),i=await b(o);else{const a=g.getItem("MINIAPP_SDK_init_data");a?(i=JSON.parse(a),console.log("üîç [DEBUG] Retrieved init data from storage")):(console.warn("‚ö†Ô∏è [DEBUG] No init data found, processing with default values"),i=await b({}))}return g.setItem("MINIAPP_SDK_init_data",JSON.stringify(i)),console.log("üîç [DEBUG] Saved init data to storage"),p&&(s.removeChild(p),console.log("üóëÔ∏è Removed old iframe")),p=document.createElement("iframe"),p.id="iframe-miniapp",p.src=t,p.style.width="100%",p.style.height="100%",p.style.border="none",s.appendChild(p),s.style.display="block",p.onload=()=>{console.log("üîç [DEBUG] Iframe loaded, sending INIT event to MiniApp"),console.log("üîç [DEBUG] Iframe origin:",p.src),console.log("üîç [DEBUG] Iframe contentWindow:",p.contentWindow),setTimeout(()=>{try{console.log("üîç [DEBUG] Sending message to iframe");const a={sender:"MINIAPP_SDK",event:"INIT",data:i,request_id:Date.now().toString()};console.log("üîç [DEBUG] Sending message to iframe"),document.getElementById("iframe-miniapp").contentWindow.postMessage(JSON.stringify(a),"*"),console.log("‚úÖ Sent INIT event to MiniApp")}catch(a){console.error("‚ùå Error sending INIT event to MiniApp:",a)}},1e3)},console.log("‚úÖ MiniApp opened in iframe:",t),console.log("‚úÖ Using init data"),{data:{url:t,containerId:n,initData:i},eventStatus:{errorCode:"SDK000",errorMessageVN:"Th√†nh c√¥ng",errorMessageEN:"Success"}}}catch(i){return console.error("‚ùå Error in openMiniApp:",i),{data:null,eventStatus:{errorCode:"SDK002",errorMessageVN:"L·ªói khi m·ªü MiniApp",errorMessageEN:"Error opening MiniApp"}}}}async function b(r){console.log("üîç [DEBUG] processInitData called"),r||(console.log("üîç [DEBUG] Input data is null, using default values"),r={});const e=u.getDeviceInfo(),t=r==null?void 0:r.msisdn;console.log("üîç [DEBUG] Calling Utils.generateClientId for processInitData");const n=await u.generateClientId();console.log("üîç [DEBUG] Generated clientId for processInitData");const o={internal:{session:null,deviceInfo:{imei:n,platform:{os:e.os,osVersion:e.osVersion}}},external:{generalInfo:{msisdn:t},serviceInfo:{}}};return console.log("üîç [DEBUG] Processed init data",o),o}function ae(r="miniapp-container"){console.log("üîç [DEBUG] closeMiniApp called with containerId:",r);const e=document.getElementById(r);if(!e)return console.log("‚ùå Container not found:",r),{data:null,eventStatus:{errorCode:"SDK001",errorMessageVN:"Container kh√¥ng t√¨m th·∫•y",errorMessageEN:"Container not found"}};try{return p?(e.removeChild(p),p=null,e.style.display="none",console.log("‚úÖ MiniApp closed successfully"),{data:{containerId:r,closed:!0},eventStatus:{errorCode:"SDK000",errorMessageVN:"Th√†nh c√¥ng",errorMessageEN:"Success"}}):(console.log("‚ö†Ô∏è No iframe to close"),{data:{containerId:r,closed:!1,message:"No iframe to close"},eventStatus:{errorCode:"SDK000",errorMessageVN:"Th√†nh c√¥ng",errorMessageEN:"Success"}})}catch(t){return console.error("‚ùå Error in closeMiniApp:",t),{data:null,eventStatus:{errorCode:"SDK003",errorMessageVN:"L·ªói khi ƒë√≥ng MiniApp",errorMessageEN:"Error closing MiniApp"}}}}async function ce(r,e){console.log("üîç [DEBUG] handleDataAction called with event:",r);try{const t=await ne(r,{data:e.data});console.log("üîç [DEBUG] callAction response received"),A({sender:I.MINIAPP_SDK,event:r,data:t.data,response_id:e.request_id,request_id:e.request_id,eventStatus:t.eventStatus})}catch(t){console.error("‚ùå Error in handleDataAction:",t),A({sender:I.MINIAPP_SDK,event:r,data:{error:!0,message:t.message}})}}l.closeMiniApp=ae,l.getEnv=F,l.getEnvWhitelist=j,l.initSDK=Y,l.onMessage=se,l.openMiniApp=ie,l.sendMessage=A,Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});
